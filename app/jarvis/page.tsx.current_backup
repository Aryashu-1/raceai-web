"use client";

import type React from "react";
import { useState, useRef, useEffect } from "react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Block } from "@/app/types/blocks";
import { ScrollArea } from "@/components/ui/scroll-area";
import {
  Accordion,
  AccordionContent,
  AccordionItem,
  AccordionTrigger,
} from "@/components/ui/accordion"
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog"
import {
  Select,
  SelectContent,
  SelectItem,
  SelectLabel,
  SelectSeparator,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select"
import { Badge } from "@/components/ui/badge";
import {
  Send,
  Mic,
  Paperclip,
  Settings,
  Share,
  Trash2,
  Pin,
  PinOff,
  Search,
  Plus,
  X,
  Edit3,
  MoreVertical,
  Monitor,
  Presentation,
  Sparkles,
  MessageCircle,
  Layout,
  MessageSquare,
  RefreshCw,
  ShieldCheck,
  FileText
} from "lucide-react";
import Markdown from "@/components/Markdown";
import BlockRenderer from "@/components/BlockRenderer";
import { useChatContext, ChatSession as ContextChatSession } from "../context/ChatContext";
import { useProjects } from "../context/ProjectContext";
import { ProjectNode } from "../types/project";

interface Message {
  id: string;
  content?: string;
  sender: "user" | "assistant";
  timestamp: Date;
  blocks?: Block[];
}

interface LocalChatSession {
  id: string;
  title: string;
  preview: string;
  timestamp: string;
  createdAt: Date;
  isPinned?: boolean;
  category: "recent" | "pinned" | "project" | "shared";
  projectName?: string;
  projectId?: string;
}

interface FilterState {
  searchText: string;
}

export default function JarvisPage() {
  const { projects } = useProjects();
  const { chatSessions, setChatSessions } = useChatContext();

  const [messages, setMessages] = useState<Message[]>([
    {
      id: "1",
      content: "Welcome to JARVIS Chat! How can I assist with your research today?",
      sender: "assistant",
      timestamp: new Date(),
    },
  ]);
  const [inputMessage, setInputMessage] = useState("");
  const [activeTab, setActiveTab] = useState<"recent" | "pinned" | "project" | "shared">("recent");
  const [isLoading, setIsLoading] = useState(false);
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const [uploadedFiles, setUploadedFiles] = useState<File[]>([]);
  const fileInputRef = useRef<HTMLInputElement>(null);

  const [filters, setFilters] = useState<FilterState>({ searchText: "" });
  const [mounted, setMounted] = useState(false);
  const [currentSessionId, setCurrentSessionId] = useState<string>("1");

  useEffect(() => {
    setMounted(true);
  }, []);

  // UI States for features
  const [hoveredChat, setHoveredChat] = useState<string | null>(null);
  const [editingChatId, setEditingChatId] = useState<string | null>(null);
  const [editTitleValue, setEditTitleValue] = useState("");
  const [isWhiteboardOpen, setIsWhiteboardOpen] = useState(false);
  const [isScreenSharing, setIsScreenSharing] = useState(false);
  const [selectedModel, setSelectedModel] = useState("gpt-4o");

  // --- MAPPERS ---
  const mapContextMessageToLocal = (msg: any): Message => ({
    id: msg.id,
    content: msg.content,
    sender: msg.role === "USER" ? "user" : "assistant",
    timestamp: new Date(msg.createdAt),
    blocks: msg.blocks || (msg.content ? [{ type: "paragraph", text: msg.content }] : []),
  });

  const mapContextSessionToLocal = (session: ContextChatSession): LocalChatSession => ({
    id: session.id,
    title: session.title || "New Chat",
    preview: session.messages.length > 0 ? session.messages[session.messages.length - 1].content : "No messages",
    timestamp: new Date(session.updatedAt || session.createdAt).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" }),
    createdAt: new Date(session.createdAt),
    isPinned: session.isPinned,
    category: session.projectId ? "project" : (session.isPinned ? "pinned" : "recent"), // Simplified logic
    projectName: getProjectName(session.projectId),
    projectId: session.projectId,
  });

  const getProjectName = (projectId?: string) => {
    if (!projectId) return undefined;
    const find = (nodes: ProjectNode[]): string | undefined => {
      for (const n of nodes) {
        if (n.id === projectId) return n.name;
        if (n.children) {
          const found = find(n.children);
          if (found) return found;
        }
      }
    }
    return find(projects) || "Unknown Project";
  }

  // --- ACTIONS ---

  const handleSelectSession = (sessionId: string) => {
    setCurrentSessionId(sessionId);
    const session = chatSessions.find((s) => s.id === sessionId);
    if (session) {
      if (session.messages?.length > 0) {
        setMessages(session.messages.map(mapContextMessageToLocal));
      } else {
        setMessages([{
          id: "welcome",
          content: "Welcome! This is a fresh conversation context.",
          sender: "assistant",
          timestamp: new Date()
        }]);
      }
    }
  };

  const handleNewChat = () => {
    const newSessionId = Date.now().toString();
    const newSession: ContextChatSession = {
      id: newSessionId,
      title: "New Chat",
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      messages: [],
      userId: "user",
      projectId: "",
      isPinned: false,
      isSaved: true
    };
    setChatSessions([newSession, ...chatSessions]);
    setCurrentSessionId(newSessionId);
    setMessages([{
      id: "1",
      content: "Welcome to JARVIS Chat! How can I assist with your research today?",
      sender: "assistant",
      timestamp: new Date(),
    }]);
  };

  const handleSendMessage = async () => {
    if (!inputMessage.trim() && uploadedFiles.length === 0) return;
    if (isLoading) return;

    const userMessage: Message = {
      id: Date.now().toString(),
      content: inputMessage,
      blocks: [{ type: "paragraph", text: inputMessage }],
      sender: "user",
      timestamp: new Date(),
    };

    setMessages((prev) => [...prev, userMessage]);
    setInputMessage("");
    setUploadedFiles([]);
    setIsLoading(true);

    try {
      // Mock response
      await new Promise(resolve => setTimeout(resolve, 1000));
      const assistantMessage: Message = {
        id: (Date.now() + 1).toString(),
        content: `I processed: "${userMessage.content}"`,
        blocks: [{ type: "paragraph", text: `I processed: "${userMessage.content}"` }],
        sender: "assistant",
        timestamp: new Date()
      };
      setMessages((prev) => [...prev, assistantMessage]);

      // Auto-rename
      if (messages.length <= 1) {
        setChatSessions(prev => prev.map(s => s.id === currentSessionId ? { ...s, title: userMessage.content?.substring(0, 30) || "New Chat" } : s));
      }
    } catch (e) {
      console.error(e);
    } finally {
      setIsLoading(false);
    }
  };

  // --- FEATURE ACTIONS ---
  const togglePin = (e: React.MouseEvent, chatId: string) => {
    e.stopPropagation();
    setChatSessions(prev => prev.map(s => s.id === chatId ? { ...s, isPinned: !s.isPinned } : s));
  };

  const deleteChat = (e: React.MouseEvent, chatId: string) => {
    e.stopPropagation();
    setChatSessions(prev => prev.filter(s => s.id !== chatId));
    if (currentSessionId === chatId) {
      setCurrentSessionId(chatSessions[0]?.id || "");
    }
  };

  const startRename = (e: React.MouseEvent, chatId: string, currentTitle: string) => {
    e.stopPropagation();
    setEditingChatId(chatId);
    setEditTitleValue(currentTitle);
  };

  const saveRename = (e: React.MouseEvent | React.KeyboardEvent | React.FocusEvent) => {
    e.stopPropagation();
    if (editingChatId) {
      setChatSessions(prev => prev.map(s => s.id === editingChatId ? { ...s, title: editTitleValue } : s));
      setEditingChatId(null);
    }
  };

  // --- RENDERERS ---
  const displaySessions = chatSessions
    .map(mapContextSessionToLocal)
    .filter(s => {
      if (filters.searchText) return s.title.toLowerCase().includes(filters.searchText.toLowerCase());
      return true;
    });

  const renderSessionItem = (session: LocalChatSession) => {
    const isEditing = editingChatId === session.id;

    return (
      <div
        key={session.id}
        className={`
                group flex items-center gap-3 p-3 rounded-xl cursor-pointer transition-all duration-200 relative
                ${currentSessionId === session.id ? "bg-primary/10 border-primary/20" : "hover:bg-muted/50 border-transparent"}
                border
            `}
        onClick={() => handleSelectSession(session.id)}
        onMouseEnter={() => setHoveredChat(session.id)}
        onMouseLeave={() => setHoveredChat(null)}
      >
        <div className={`w-10 h-10 rounded-full flex items-center justify-center shrink-0 ${currentSessionId === session.id ? "bg-primary text-primary-foreground" : "bg-muted text-muted-foreground"}`}>
          <MessageSquare size={18} />
        </div>

        <div className="flex-1 min-w-0 relative">
          <div className="flex items-center justify-between mb-0.5">
            {isEditing ? (
              <Input
                value={editTitleValue}
                onChange={(e) => setEditTitleValue(e.target.value)}
                onClick={(e) => e.stopPropagation()}
                onKeyDown={(e) => { if (e.key === 'Enter') saveRename(e); }}
                className="h-6 text-sm py-0 px-1"
                autoFocus
                onBlur={(e) => saveRename(e)}
              />
            ) : (
              <span className={`text-sm font-medium truncate pr-16 ${currentSessionId === session.id ? "text-foreground" : "text-muted-foreground group-hover:text-foreground"}`}>
                {session.title}
              </span>
            )}
            {session.isPinned && !isEditing && <Pin size={10} className="text-primary ml-1 transform rotate-45 shrink-0" />}
          </div>
          {!isEditing && (
            <div className="flex justify-between items-end">
              <p className="text-xs text-muted-foreground truncate opacity-70 w-32">
                {session.preview}
              </p>
              <span className="text-[10px] text-muted-foreground">{mounted ? session.timestamp : ''}</span>
            </div>
          )}

          {/* Inline Hover Actions */}
          {!isEditing && (
            <div className="absolute right-0 top-0 bottom-0 flex items-center gap-1 bg-gradient-to-l from-background via-background to-transparent pl-4 opacity-0 group-hover:opacity-100 transition-opacity">
              <Button
                variant="ghost" size="icon" className="h-6 w-6 text-muted-foreground hover:text-primary"
                onClick={(e) => startRename(e, session.id, session.title)}
                title="Rename"
              >
                <Edit3 size={12} />
              </Button>
              <Button
                variant="ghost" size="icon" className="h-6 w-6 text-muted-foreground hover:text-primary"
                onClick={(e) => togglePin(e, session.id)}
                title={session.isPinned ? "Unpin" : "Pin"}
              >
                {session.isPinned ? <PinOff size={12} /> : <Pin size={12} />}
              </Button>
              <Button
                variant="ghost" size="icon" className="h-6 w-6 text-muted-foreground hover:text-destructive"
                onClick={(e) => deleteChat(e, session.id)}
                title="Delete"
              >
                <Trash2 size={12} />
              </Button>
            </div>
          )}
        </div>
      </div>
    );
  };

  const renderProjectList = (nodes: ProjectNode[]): React.ReactNode[] => {
    return nodes.map(node => {
      if (node.type === "project") {
        const projectChats = displaySessions.filter(s => s.projectId === node.id);
        if (projectChats.length === 0) return null;

        return (
          <AccordionItem key={node.id} value={node.id} className="border-b border-white/10">
            <AccordionTrigger className="hover:no-underline py-2 text-sm px-2 hover:bg-white/5 rounded-lg">
              <div className="flex items-center gap-2">
                <Layout size={14} className="text-green-500" />
                <span>{node.name}</span>
              </div>
            </AccordionTrigger>
            <AccordionContent>
              <div className="pl-4 space-y-1 mt-1">
                {projectChats.map(s => (
                  <div key={s.id} onClick={() => handleSelectSession(s.id)} className={`cursor-pointer p-2 rounded-md text-sm flex items-center gap-2 ${currentSessionId === s.id ? "bg-primary/20 text-primary" : "hover:bg-white/5 text-muted-foreground"}`}>
                    <MessageCircle size={12} />
                    <span className="truncate">{s.title}</span>
                  </div>
                ))}
              </div>
            </AccordionContent>
          </AccordionItem>
        )
      }
      if (node.children) return renderProjectList(node.children);
      return null;
    })
  };

  return (
    <div className="h-screen flex bg-background dark:bg-gradient-to-br dark:from-slate-950 dark:via-blue-950/40 dark:to-slate-900 relative overflow-hidden">

      {/* Sidebar */}
      <div className="hidden md:flex md:w-80 lg:w-96 border-r border-border bg-background flex-col relative z-10 transition-all duration-300">
        <div className="p-4 border-b border-border">
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-2">
              <div className="w-8 h-8 bg-primary rounded-lg flex items-center justify-center text-primary-foreground">
                <Sparkles size={18} />
              </div>
              <span className="font-semibold text-lg tracking-tight">RaceAI Chat</span>
            </div>
            <Button size="icon" variant="ghost" className="rounded-full" onClick={handleNewChat} title="New Chat">
              <Edit3 size={18} />
            </Button>
          </div>

          <div className="mb-4 w-full relative group">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground group-focus-within:text-primary transition-colors" />
            <input
              className="w-full bg-muted/50 border border-transparent focus:bg-background focus:border-primary rounded-xl h-10 pl-9 pr-4 text-sm transition-all"
              placeholder="Search conversations..."
              value={filters.searchText}
              onChange={(e) => setFilters({ searchText: e.target.value })}
            />
          </div>

          <div className="flex p-1.5 bg-muted/50 rounded-xl">
            {['recent', 'pinned', 'project', 'shared'].map(tab => (
              <button
                key={tab}
                onClick={() => setActiveTab(tab as any)}
                className={`
                                flex-1 text-[11px] font-medium py-1.5 rounded-lg capitalize transition-all duration-200
                                ${activeTab === tab
                    ? "bg-background shadow-sm text-foreground scale-[1.02]"
                    : "text-muted-foreground hover:text-foreground hover:bg-background/50"}
                            `}
              >
                {tab}
              </button>
            ))}
          </div>
        </div>

        <ScrollArea className="flex-1 px-3">
          {activeTab === 'project' ? (
            <div className="py-2">
              <Accordion type="multiple" className="w-full">
                {renderProjectList(projects)}
              </Accordion>
            </div>
          ) : (
            <div className="space-y-1 py-2">
              {displaySessions
                .filter(s => {
                  if (activeTab === 'pinned') return s.isPinned;
                  return true;
                })
                .map(renderSessionItem)
              }
            </div>
          )}
        </ScrollArea>

        {/* Sidebar Footer */}
        <div className="p-4 border-t border-border bg-background/50 backdrop-blur-md">
          <div className="flex items-center gap-3 p-2 rounded-xl hover:bg-muted/50 cursor-pointer transition-colors group">
            <div className="w-9 h-9 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 flex items-center justify-center text-white font-medium shadow-sm">
              JS
            </div>
            <div className="flex-1 min-w-0">
              <p className="text-sm font-medium truncate group-hover:text-primary transition-colors">John Smith</p>
              <p className="text-xs text-muted-foreground truncate">Pro Plan</p>
            </div>
            <Settings size={16} className="text-muted-foreground group-hover:text-foreground transition-colors" />
          </div>
        </div>
      </div>

      {/* Main Area */}
      <div className="flex-1 flex flex-col relative z-0 bg-background/50">
        {/* Header */}
        <div className="h-16 border-b border-border flex items-center justify-between px-6 bg-background/80 backdrop-blur-xl z-10 sticky top-0">
          <div className="flex items-center gap-4">
            <div className="flex flex-col">
              <h2 className="font-semibold flex items-center gap-2">
                {chatSessions.find(s => s.id === currentSessionId)?.title || "Fresh Chat"}
              </h2>
              <div className="text-xs text-muted-foreground flex items-center gap-1.5">
                {getProjectName(chatSessions.find(s => s.id === currentSessionId)?.projectId) && (
                  <>
                    <Layout size={10} />
                    <span>{getProjectName(chatSessions.find(s => s.id === currentSessionId)?.projectId)}</span>
                    <span className="text-border">â€¢</span>
                  </>
                )}
                <span className="flex items-center gap-1">
                  <div className="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div>
                  Online
                </span>
              </div>
            </div>
          </div>

          {/* Model Selector & Actions */}
          <div className="flex items-center gap-2">
            <Select value={selectedModel} onValueChange={setSelectedModel}>
              <SelectTrigger className="w-[180px] h-9 bg-muted/50 border-transparent hover:bg-muted transition-colors rounded-lg">
                <SelectValue placeholder="Select Model" />
              </SelectTrigger>
              <SelectContent align="end" className="w-[280px]">
                <SelectLabel className="text-xs text-muted-foreground px-2 py-1.5">Reasoning Models</SelectLabel>
                <SelectItem value="gpt-4o">
                  <div className="flex items-center justify-between w-full">
                    <span>GPT-4o</span>
                    <Badge variant="secondary" className="text-[10px] h-4">Fast</Badge>
                  </div>
                </SelectItem>
                <SelectItem value="o1-preview">
                  <div className="flex items-center justify-between w-full">
                    <span>o1 Preview</span>
                    <Badge variant="default" className="text-[10px] h-4 bg-purple-500 hover:bg-purple-600">Reasoning</Badge>
                  </div>
                </SelectItem>
                <SelectSeparator />
                <SelectLabel className="text-xs text-muted-foreground px-2 py-1.5">Standard</SelectLabel>
                <SelectItem value="claude-3-5-sonnet">Claude 3.5 Sonnet</SelectItem>
                <SelectItem value="gemini-1.5-pro">Gemini 1.5 Pro</SelectItem>
                <SelectItem value="llama-3.1-405b">Llama 3.1 405B</SelectItem>
              </SelectContent>
            </Select>

            <div className="h-6 w-[1px] bg-border mx-2"></div>

            <Button
              variant="ghost" size="icon"
              className={`hover:bg-primary/10 hover:text-primary transition-colors ${isWhiteboardOpen ? "bg-primary/10 text-primary" : "text-muted-foreground"}`}
              onClick={() => setIsWhiteboardOpen(!isWhiteboardOpen)}
              title="Toggle Whiteboard"
            >
              <Presentation size={18} />
            </Button>
            <Button
              variant="ghost" size="icon"
              className={`hover:bg-green-500/10 hover:text-green-500 transition-colors ${isScreenSharing ? "bg-green-500/10 text-green-500" : "text-muted-foreground"}`}
              onClick={() => setIsScreenSharing(!isScreenSharing)}
              title="Screen Share"
            >
              <Monitor size={18} />
            </Button>
            <Button variant="ghost" size="icon" className="text-muted-foreground hover:text-foreground hover:bg-muted" title="Share Chat"><Share size={18} /></Button>
            <Button variant="ghost" size="icon" className="text-muted-foreground hover:text-foreground hover:bg-muted" title="Chat Settings"><Settings size={18} /></Button>
          </div>
        </div>

        {/* Messages Area */}
        <ScrollArea className="flex-1 p-4 md:p-8">
          <div className="max-w-3xl mx-auto space-y-8 pb-10">
            {messages.map((msg) => (
              <div key={msg.id} className={`flex gap-4 group/msg ${msg.sender === "user" ? "flex-row-reverse" : "flex-row"}`}>
                <div className={`w-8 h-8 rounded-full flex items-center justify-center shrink-0 mt-1 shadow-sm ${msg.sender === "user" ? "bg-gradient-to-tr from-blue-600 to-blue-500 text-white" : "bg-card border border-border text-foreground"}`}>
                  {msg.sender === "user" ? "U" : <Sparkles size={16} className="text-purple-500" />}
                </div>

                <div className={`flex flex-col max-w-[85%] ${msg.sender === "user" ? "items-end" : "items-start"}`}>
                  <div className={`px-5 py-3.5 rounded-2xl text-[15px] shadow-sm leading-relaxed relative group-hover/msg:shadow-md transition-all
                                    ${msg.sender === "user"
                      ? "bg-gradient-to-tr from-blue-600 to-blue-500 text-white rounded-tr-sm"
                      : "bg-card border border-border text-foreground rounded-tl-sm"}
                                `}>
                    {msg.blocks ? (
                      <div className="space-y-4">
                        {msg.blocks.map((block, i) => <BlockRenderer key={i} block={block} />)}
                      </div>
                    ) : (
                      <Markdown>{msg.content || ""}</Markdown>
                    )}
                  </div>

                  <div className={`flex items-center gap-2 mt-1.5 px-1 opacity-0 group-hover/msg:opacity-100 transition-opacity duration-300 ${msg.sender === "user" ? "flex-row-reverse" : "flex-row"}`}>
                    <span className="text-[10px] text-muted-foreground font-medium">
                      {mounted ? msg.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : ''}
                    </span>
                    {msg.sender === 'assistant' && (
                      <>
                        <Button variant="ghost" size="icon" className="h-5 w-5 text-muted-foreground hover:text-foreground" title="Copy"><Layout size={10} /></Button>
                        <Button variant="ghost" size="icon" className="h-5 w-5 text-muted-foreground hover:text-foreground" title="Regenerate"><RefreshCw size={10} /></Button>
                      </>
                    )}
                  </div>
                </div>
              </div>
            ))}

            {messages.length <= 1 && (
              <div className="grid grid-cols-2 gap-4 mt-8 animate-in fade-in slide-in-from-bottom-4 duration-700">
                {['Suggest research topics for...', 'Draft a literature review about...', 'Explain the methodology of...', 'Analyze this data set...'].map((suggestion, i) => (
                  <button
                    key={i}
                    className="p-4 rounded-xl border border-border bg-card/30 hover:bg-card hover:border-primary/30 transition-all text-left group"
                    onClick={() => { setInputMessage(suggestion); document.querySelector('textarea')?.focus(); }}
                  >
                    <p className="text-sm font-medium text-foreground group-hover:text-primary transition-colors">{suggestion}</p>
                    <p className="text-xs text-muted-foreground mt-1">Get started quickly</p>
                  </button>
                ))}
              </div>
            )}

            <div ref={messagesEndRef} />
          </div>
        </ScrollArea>

        {/* Dynamic Input Area */}
        <div className="p-4 lg:p-6 border-t border-border bg-background/50 backdrop-blur-md">
          <div className="max-w-3xl mx-auto relative group">
            <div className={`
                        bg-muted/30 border border-border/50 focus-within:border-primary/50 focus-within:bg-background focus-within:ring-2 focus-within:ring-primary/10 
                        transition-all duration-300 rounded-3xl p-3 shadow-sm hover:shadow-md
                     `}>
              {uploadedFiles.length > 0 && (
                <div className="flex gap-2 px-2 pb-3 overflow-x-auto">
                  {uploadedFiles.map((f, i) => (
                    <Badge key={i} variant="secondary" className="text-xs gap-1.5 py-1 pl-2 pr-1 rounded-lg bg-background border border-border shadow-sm">
                      <FileText size={10} className="text-blue-500" />
                      <span className="max-w-[100px] truncate">{f.name}</span>
                      <div className="h-full w-[1px] bg-border mx-1"></div>
                      <X size={12} className="cursor-pointer hover:text-destructive transition-colors" onClick={() => setUploadedFiles(prev => prev.filter((_, idx) => idx !== i))} />
                    </Badge>
                  ))}
                </div>
              )}

              <div className="flex gap-2 items-end">
                <Button
                  variant="ghost" size="icon"
                  className="h-9 w-9 text-muted-foreground hover:text-foreground hover:bg-muted rounded-full shrink-0 mb-0.5"
                  onClick={() => fileInputRef.current?.click()}
                  title="Attach File"
                >
                  <Paperclip size={18} />
                  <input type="file" ref={fileInputRef} className="hidden" multiple onChange={(e) => { const f = e.target.files; if (f) setUploadedFiles(p => [...p, ...Array.from(f)]) }} />
                </Button>

                <textarea
                  value={inputMessage}
                  onChange={(e) => setInputMessage(e.target.value)}
                  onKeyDown={(e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); } }}
                  placeholder="Message Jarvis..."
                  className="w-full bg-transparent border-none resize-none focus:ring-0 px-2 py-2.5 text-sm min-h-[44px] max-h-[200px] placeholder:text-muted-foreground/50"
                  rows={1}
                  style={{ height: inputMessage ? 'auto' : '44px' }}
                />

                <div className="flex gap-1 shrink-0 mb-0.5">
                  {inputMessage.trim() || uploadedFiles.length > 0 ? (
                    <Button
                      size="icon"
                      onClick={handleSendMessage}
                      className="h-9 w-9 rounded-full bg-primary text-primary-foreground shadow-lg hover:shadow-xl hover:scale-105 transition-all"
                    >
                      <Send size={16} className="ml-0.5" />
                    </Button>
                  ) : (
                    <Button variant="ghost" size="icon" className="h-9 w-9 text-muted-foreground hover:text-foreground rounded-full">
                      <Mic size={18} />
                    </Button>
                  )}
                </div>
              </div>
            </div>
            <div className="text-center mt-3 flex items-center justify-center gap-2 opacity-50 hover:opacity-100 transition-opacity">
              <ShieldCheck size={10} className="text-muted-foreground" />
              <p className="text-[10px] text-muted-foreground">AI can make mistakes. Verify important information.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
